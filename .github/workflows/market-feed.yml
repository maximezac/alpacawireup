name: Publish market feed with indicators & news

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas

      - name: Run publisher (may write prices_full.json or prices.json)
        env:
          ALPACA_KEY: ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_FEED: iex
          INDICATOR_TIMEFRAME: 1Day
          HIST_LIMIT: 200
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          PORTFOLIO_B_TICKERS: QBTS,VTI,ASTS,RKLB,VOO,NVDA,ARCC,TTWO,AMZN,RGTI,QUBT
        run: |
          mkdir -p data
          # ok if this exits non-zero; we’ll fall back to Gist
          python scripts/publish_feed.py || true

      - name: Ensure full feed exists (prefer local; else fetch from Gist)
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          mkdir -p data
          if [ -s data/prices_full.json ]; then
            echo "Found data/prices_full.json"
          elif [ -s data/prices.json ]; then
            echo "Found data/prices.json; copying to prices_full.json"
            cp data/prices.json data/prices_full.json
          else
            echo "No local feed, trying Gist..."
            python scripts/fetch_from_gist.py
          fi

      - name: Minify feed (using your existing minify_feed.py)
        run: |
          python scripts/minify_feed.py < data/prices_full.json > data/prices.json
          echo "✅ Minified feed written to data/prices.json"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: prices.json
          path: data/prices.json
