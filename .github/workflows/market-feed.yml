name: Market Feed (Fetch → Analyze → Publish)

on:
  workflow_dispatch:


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Configure environment
        run: |
          mkdir -p data
          echo "TZ=America/Chicago" >> $GITHUB_ENV
        shell: bash

      - name: Fetch & build base feed (Alpaca → data/prices.json)
        env:
          ALPACA_KEY: ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
        run: |
          python scripts/publish_feed.py

      - name: Analyze (Algorithm v2.2) → data/prices_final.json
        env:
          NEWS_DECAY: "0.5"
          SECTOR_CORRELATION_PENALTY: "0.1"
        run: |
          python scripts/analyze_feed.py --in data/prices.json --out data/prices_final.json

      - name: Publish to Gist (overwrite file)
        if: ${{ success() }}
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_FILENAME: "prices.json"
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          echo "Updating Gist $GIST_ID ..."
          jq -n --arg content "$(cat data/prices_final.json)" '{files: {($ENV.GIST_FILENAME): {content: $content}}}' > payload.json
          curl -sS -X PATCH \
            -H "Authorization: token ${GIST_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/gists/${GIST_ID} \
            -d @payload.json \
            > gist_response.json
          cat gist_response.json | jq '.id, .updated_at'
