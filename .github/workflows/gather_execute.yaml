name: Gather + Execute (paper; multi-portfolio v3)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no trade execution)"
        required: false
        default: "false"
      tags:
        description: "Execute only portfolios with any of these tags (comma-separated). Default: paper"
        required: false
        default: "paper"
  schedule:
    # ~30 min before US close (EDT ~20:00 UTC -> 19:30; EST ~21:00 UTC -> 20:30)
    - cron: "30 19 * * 1-5"
    - cron: "30 20 * * 1-5"

permissions:
  contents: write

concurrency:
  group: gather-exec-paper-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      # ---- Core paths ----
      INPUT_BASE: data/prices.json
      INPUT_FINAL: data/prices_final.json
      OUTPUT_DIR: artifacts
      CONFIG_PORTFOLIOS: config/portfolios.yml
      CONFIG_STRATEGIES: config/strategies.yml

      # ---- Execution scope/tags (paper-only) ----
      EXECUTE_SCOPE: paper
      EXECUTE_TAGS: ${{ inputs.tags || 'paper' }}

      # ---- Slippage / liquidity knobs (defaults) ----
      SLIPPAGE_BPS_DEFAULT: "10"
      SLIPPAGE_BPS_PERSONAL: "5"
      LIQ_IMPACT_BPS_SMALLCAP: "5"
      SMALLCAPS: "QBTS,QUBT,RGTI,ASTS,RKLB,SOFI"

      # ---- Files produced/consumed by v3 scripts ----
      TRADE_PLANS: artifacts/recommended_trades.json
      IDEMPOTENCY_FILE: artifacts/_applied_recs_state.json
      LEDGER_CSV: data/trades_ledger.csv

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          # ensure v3 deps are present
          pip install pandas==2.2.2 numpy==1.26.4 requests==2.32.3 \
                      python-dateutil==2.9.0.post0 feedparser==6.0.11 \
                      pyyaml==6.0.2

      # ---------- Freshness probe ----------
      - name: Probe freshness
        id: probe
        shell: bash
        run: |
          prices_final="$INPUT_FINAL"
          prices_base="$INPUT_BASE"
          now=$(date +%s)
          fresh_prices=false
          fresh_base=false
          [[ -f "$prices_final" ]] && [[ $((now - $(stat -c %Y "$prices_final"))) -lt 600  ]] && fresh_prices=true
          [[ -f "$prices_base"  ]] && [[ $((now - $(stat -c %Y "$prices_base")))  -lt 3600 ]] && fresh_base=true
          echo "fresh_prices=$fresh_prices" >> "$GITHUB_OUTPUT"
          echo "fresh_base=$fresh_base"     >> "$GITHUB_OUTPUT"

      # ---------- DATA FETCH (only if stale) ----------
      - name: Fetch prices
        if: steps.probe.outputs.fresh_prices != 'true'
        env:
          ALPACA_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_DATA_FEED: "iex"
          SYMBOLS_PATH: data/symbols.txt
          OUTPUT_PATH: ${{ env.INPUT_BASE }}
          DAYS_BACK: "270"
        run: python fetch_prices.py

      - name: Fetch news
        if: steps.probe.outputs.fresh_base != 'true'
        env:
          ALPACA_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          INPUT_PATH: ${{ env.INPUT_BASE }}
          OUTPUT_PATH: ${{ env.INPUT_BASE }}
          NEWS_LOOKBACK_DAYS: "7"
          NEWS_LIMIT_PER_SYMBOL: "25"
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          FINNHUB_KEY: ${{ secrets.FINNHUB_KEY }}
          NEWS_SOURCES: "benzinga,mtnewswires,google_rss,finnhub,reddit"
        run: python fetch_news.py

      - name: Generate enriched feed
        env:
          INPUT_PATH:  ${{ env.INPUT_BASE }}
          OUTPUT_PATH: ${{ env.INPUT_FINAL }}
          MAX_ARTICLES: "15"
          DECAY_HALF_LIFE_HOURS: "12"
          SECTOR_NUDGE: "0.05"
          GENERATE_NOW: "1"
          ALPACA_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: python publish_feed.py

      # ---------- POSTPROCESS (multi-portfolio v3) ----------
      - name: Build recs for all portfolios (v3)
        env:
          INPUT_FINAL: ${{ env.INPUT_FINAL }}
          CONFIG_PORTFOLIOS: ${{ env.CONFIG_PORTFOLIOS }}
          CONFIG_STRATEGIES: ${{ env.CONFIG_STRATEGIES }}
          OUTPUT_DIR: ${{ env.OUTPUT_DIR }}
        run: |
          python scripts/postprocess_v3.py
          python -c "import os,json; p=os.environ.get('TRADE_PLANS','data/recommended_trades.json'); o=json.load(open(p)); tot=0; \
          [print(f'- {k}: {len(v.get(\"trades\",[]))} trades') or (tot:=tot+len(v.get('trades',[]))) for k,v in (o.get('portfolios') or {}).items()]; \
          print('TOTAL TRADES:',tot)"


      # ---------- Idempotency per snapshot ----------
      - name: Check snapshot idempotency
        id: idem
        shell: bash
        run: |
          set -e
          SNAP_ASOF=$(jq -r '.as_of_utc' < "${TRADE_PLANS}")
          LAST_ASOF=""
          if [[ -f "${IDEMPOTENCY_FILE}" ]]; then
            LAST_ASOF=$(jq -r '.last_as_of_utc // ""' < "${IDEMPOTENCY_FILE}")
          fi
          SKIP=false
          if [[ -n "$SNAP_ASOF" && "$SNAP_ASOF" == "$LAST_ASOF" ]]; then
            SKIP=true
          fi
          echo "as_of_utc=$SNAP_ASOF"
          echo "skip=$SKIP"
          echo "skip=$SKIP" >> "$GITHUB_OUTPUT"

      # ---------- EXECUTE TRADES (paper scope, tagged filter) ----------
      - name: Execute trades (paper portfolios)
        if: steps.idem.outputs.skip != 'true' && (github.event_name != 'workflow_dispatch' || inputs.dry_run != 'true')
        env:
          INPUT_FINAL: ${{ env.INPUT_FINAL }}
          CONFIG_PORTFOLIOS: ${{ env.CONFIG_PORTFOLIOS }}
          TRADE_PLANS: ${{ env.TRADE_PLANS }}
          LEDGER_PATH: ${{ env.LEDGER_CSV }}
          EXECUTE_SCOPE: ${{ env.EXECUTE_SCOPE }}
          EXECUTE_TAGS:  ${{ env.EXECUTE_TAGS }}
          DRY_RUN: "0"
          SLIPPAGE_BPS_DEFAULT: ${{ env.SLIPPAGE_BPS_DEFAULT }}
          SLIPPAGE_BPS_PERSONAL: ${{ env.SLIPPAGE_BPS_PERSONAL }}
          LIQ_IMPACT_BPS_SMALLCAP: ${{ env.LIQ_IMPACT_BPS_SMALLCAP }}
          SMALLCAPS: ${{ env.SMALLCAPS }}
        run: |
          python scripts/update_performance_v3.py
          tail -n 25 "${LEDGER_CSV}" || true

      - name: Mark snapshot as applied
        if: steps.idem.outputs.skip != 'true' && (github.event_name != 'workflow_dispatch' || inputs.dry_run != 'true')
        shell: bash
        run: |
          mkdir -p "$(dirname "${IDEMPOTENCY_FILE}")"
          jq -n --arg asof "$(jq -r '.as_of_utc' < "${TRADE_PLANS}")" \
            '{last_as_of_utc: $asof}' > "${IDEMPOTENCY_FILE}"
          cat "${IDEMPOTENCY_FILE}"

      # ---------- Rebuild recs after execution (so feed reflects new positions) ----------
      - name: Rebuild recs post-exec (v3)
        if: steps.idem.outputs.skip != 'true' && (github.event_name != 'workflow_dispatch' || inputs.dry_run != 'true')
        env:
          INPUT_FINAL: ${{ env.INPUT_FINAL }}
          CONFIG_PORTFOLIOS: ${{ env.CONFIG_PORTFOLIOS }}
          CONFIG_STRATEGIES: ${{ env.CONFIG_STRATEGIES }}
          OUTPUT_DIR: ${{ env.OUTPUT_DIR }}
        run: python scripts/postprocess_v3.py

      # ---------- Snapshot (no-trade pass) ----------
      - name: Append performance snapshots (no trades)
        env:
          INPUT_FINAL: ${{ env.INPUT_FINAL }}
          CONFIG_PORTFOLIOS: ${{ env.CONFIG_PORTFOLIOS }}
          TRADE_PLANS: ${{ env.TRADE_PLANS }}
          LEDGER_PATH: ${{ env.LEDGER_CSV }}
          EXECUTE_SCOPE: none
          EXECUTE_TAGS: ""
          DRY_RUN: "1"
          SLIPPAGE_BPS_DEFAULT: ${{ env.SLIPPAGE_BPS_DEFAULT }}
          SLIPPAGE_BPS_PERSONAL: ${{ env.SLIPPAGE_BPS_PERSONAL }}
          LIQ_IMPACT_BPS_SMALLCAP: ${{ env.LIQ_IMPACT_BPS_SMALLCAP }}
          SMALLCAPS: ${{ env.SMALLCAPS }}
        run: python scripts/update_performance_v3.py

      - name: Commit & push artifacts
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin ${{ github.ref_name }}
          git add \
            data/prices.json data/prices_final.json \
            artifacts/**/*.json artifacts/*.json \
            data/trades_ledger.csv \
            data/portfolio_*.csv data/portfolio_*_history.csv \
            data/perf_summary_*.json
          git commit -m "auto: gather + execute (paper scope=${{ env.EXECUTE_SCOPE }}, tags=${{ env.EXECUTE_TAGS }}, dry_run=${{ inputs.dry_run || 'false' }})" || echo "No changes."
          git push
