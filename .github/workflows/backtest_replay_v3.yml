name: Backtest Strategy v3

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Backtest start date (YYYY-MM-DD)"
        required: true
        default: "2022-01-01"
      end_date:
        description: "Backtest end date (YYYY-MM-DD, blank = use today UTC)"
        required: false
        default: ""
      step_days:
        description: "Step size in days (1 = daily, 5 = approx weekly)"
        required: false
        default: "1"

permissions:
  contents: read

env:
  BACKTEST_PRICES_PATH: data/prices_backfill.json
  SNAPSHOT_OUTPUT_PATH: data/prices_snapshot.json

  # Where publish_feed writes
  INPUT_FINAL: data/prices_final_backtest.json

  PORTFOLIOS_YML: config/portfolios.yml

jobs:
  backtest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.2.2 numpy==1.26.4 requests==2.32.3 \
                      python-dateutil==2.9.0.post0 feedparser==6.0.11 \
                      vaderSentiment==3.3.2 pyyaml==6.0.2
          pip install -r requirements.txt || echo "requirements.txt already satisfied."

      - name: Export PYTHONPATH
        run: echo "PYTHONPATH=$PWD" >> "$GITHUB_ENV"

      - name: Download backfill artifact
        uses: actions/download-artifact@v4
        with:
          name: prices-backfill
          path: .
      # At this point you should have ./data/prices_backfill.json from the other workflow

      - name: Compute backtest date range
        id: dates
        run: |
          set -euo pipefail
          START="${{ github.event.inputs.start_date }}"
          END_IN="${{ github.event.inputs.end_date }}"
          STEP="${{ github.event.inputs.step_days }}"

          if [[ -z "$END_IN" ]]; then
            END=$(date -u +%F)
          else
            END="$END_IN"
          fi

          echo "start_date=$START" >> "$GITHUB_OUTPUT"
          echo "end_date=$END" >> "$GITHUB_OUTPUT"
          echo "step_days=$STEP" >> "$GITHUB_OUTPUT"

          echo "Backtest range: $START → $END (step=$STEP days)"

      - name: Run backtest replay loop
        env:
          BACKTEST_PRICES_PATH: ${{ env.BACKTEST_PRICES_PATH }}
          SNAPSHOT_OUTPUT_PATH: ${{ env.SNAPSHOT_OUTPUT_PATH }}
          INPUT_FINAL:          ${{ env.INPUT_FINAL }}
          PORTFOLIOS_YML:       ${{ env.PORTFOLIOS_YML }}
          START_DATE:           ${{ steps.dates.outputs.start_date }}
          END_DATE:             ${{ steps.dates.outputs.end_date }}
          STEP_DAYS:            ${{ steps.dates.outputs.step_days }}
        run: |
          set -euo pipefail

          mkdir -p artifacts

          # Helper: add N days to a YYYY-MM-DD string
          add_days() {
            local date="$1"
            local days="$2"
            date -u -d "$date + $days day" +%F
          }

          current="$START_DATE"
          end="$END_DATE"
          step="$STEP_DAYS"
          i=0

          echo "[INFO] Starting backtest loop from $current → $end (step=$step)"


          while true; do
            echo ""
            echo "=== Backtest step $i — as of $current ==="

            # 1) Build snapshot from multi-year backfill
            export SNAPSHOT_AS_OF="$current"
            python scripts/build_snapshot_from_backfill.py

            # 2) Run publish_feed on snapshot → prices_final_backtest.json
            INPUT_PATH="$SNAPSHOT_OUTPUT_PATH" \
            OUTPUT_PATH="$INPUT_FINAL" \
            GENERATE_NOW="1" \
            python publish_feed.py

            # 3) Run postprocess_v3 in "backtest mode"
            #    NOTE: OUT_TRADES is per-date so we don't overwrite.
            INPUT_FINAL="$INPUT_FINAL" \
            PORTFOLIOS_YML="$PORTFOLIOS_YML" \
            OUT_WATCHLIST="artifacts/backtest_watchlist_${current}.json" \
            OUT_TRADES="artifacts/backtest_trades_${current}.json" \
            BACKTEST_MODE="1" \
            python scripts/postprocess_v3.py

            # stop if we've reached the end
            if [[ "$current" == "$end" ]]; then
              break
            fi

            # advance
            current=$(add_days "$current" "$step")
            i=$((i+1))
          done

          echo "[INFO] Backtest loop finished."

      - name: Package backtest outputs
        run: |
          ls -lh artifacts
          # Optional: you can combine/aggregate JSON → CSV here with a tiny Python script
          # For now we just leave individual per-date JSONs.

      - name: Upload backtest artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results
          path: artifacts
          retention-days: 30
