name: Backfill Prices (multi-year)

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  BACKFILL_OUTPUT: data/prices_backfill.json

jobs:
  backfill-prices-and-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          which python
          python -m pip install --upgrade pip
          pip install pandas==2.2.2 numpy==1.26.4 requests==2.32.3 \
                      python-dateutil==2.9.0.post0 feedparser==6.0.11 \
                      vaderSentiment==3.3.2 pyyaml==6.0.2
          pip install -r requirements.txt || echo "requirements.txt already satisfied."

      - name: Export PYTHONPATH
        run: echo "PYTHONPATH=$PWD" >> "$GITHUB_ENV"

      - name: Backfill prices (multi-year daily + intraday)
        env:
          ALPACA_KEY_ID:     ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_DATA_FEED:  iex
          SYMBOLS_PATH:      data/symbols.txt
          SECTORS_PATH:      data/sectors.json
          OUTPUT_PATH:       ${{ env.BACKFILL_OUTPUT }}
          # ~6 years of daily bars (tune as you like)
          DAYS_BACK:         "1500"
          # Intraday config (5m window for 6 months; tune or set 0 to disable)
          INTRADAY_TIMEFRAME:    "5Min"
          INTRADAY_DAYS_BACK_5M: "180"
          INTRADAY_BARS_MAX:     "500"
          REQUEST_TIMEOUT_SEC:   "15"
          REQUEST_SLEEP_SEC:     "0.25"
          COVERAGE_STRICT:       "1"
        run: python fetch_prices.py

      - name: Backfill news for backfill file
        env:
          INPUT_PATH:   ${{ env.BACKFILL_OUTPUT }}
          OUTPUT_PATH:  ${{ env.BACKFILL_OUTPUT }}
          # For now, just attach recent news; you can tighten/extend this later
          NEWS_LOOKBACK_DAYS: "30"
          NEWS_LIMIT_PER_SYMBOL: "50"
          NEWS_SOURCES: "benzinga,mtnewswires,google_rss,finnhub,reddit"
          ALPACA_KEY_ID:     ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          NEWSAPI_KEY:       ${{ secrets.NEWSAPI_KEY }}
          FINNHUB_KEY:       ${{ secrets.FINNHUB_KEY }}
          USE_FINBERT:       "1"
          FINBERT_TRIGGER:   "0.20"
          FINBERT_FRACTION:  "0.30"
        run: python scripts/fetch_news.py

      - name: Quick stats on backfill
        run: |
          echo "as_of_utc:" $(jq -r '.as_of_utc' $BACKFILL_OUTPUT)
          echo "symbols:"   $(jq '.symbols|keys|length' $BACKFILL_OUTPUT)
          echo "sample symbol:" $(jq -r '.symbols|keys[0]' $BACKFILL_OUTPUT)
          echo "has intraday meta:" $(jq -r '.intraday // empty' $BACKFILL_OUTPUT)

      - name: Commit & push backfill
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin ${{ github.ref_name }}
          git add $BACKFILL_OUTPUT || true
          git commit -m "Backfill: multi-year prices_backfill.json" || echo "No changes."
          git push || echo "No changes to push."
