name: Backtest Strategy v3

1. **Find the existing ledger_timestamp function** (or wherever the ledger timestamp is set) in your Python codebase.
2. **Replace it with the following code:**
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.2.2 numpy==1.26.4 requests==2.32.3 \
                      python-dateutil==2.9.0.post0 feedparser==6.0.11 \
                      vaderSentiment==3.3.2 pyyaml==6.0.2
          pip install -r requirements.txt || echo "requirements.txt already satisfied."

      - name: Export PYTHONPATH
        run: echo "PYTHONPATH=$PWD" >> "$GITHUB_ENV"

      # ------------------------------------------------------------------
      # 1) Download the backfilled prices + news from previous workflow
      #    (artifact name must match your Backfill workflow: "prices-backfill")
      # ------------------------------------------------------------------
      - name: Restore backfill from cache
        id: cache-backfill
        uses: actions/cache@v4
        with:
          path: data/prices_backfill.tar.gz
          key: backfill-v1-${{ hashFiles('data/symbols_backtest.txt') }}

      - name: Extract backfill JSON
        if: steps.cache-backfill.outputs.cache-hit == 'true'
        run: |
          mkdir -p data
          tar -xzf data/prices_backfill.tar.gz -C data
          ls -lh data/prices_backfill.*

      - name: Fail if backfill cache is missing
        if: steps.cache-backfill.outputs.cache-hit != 'true'
        run: |
          echo "ERROR: Backfill cache not found."
          echo "Run the 'Backfill History (prices + news)' workflow once to generate it." >&2
          exit 1

      - name: Sanity check backfill file
        run: |
          python - << 'PY'
          import json, pathlib
          p = pathlib.Path("data/prices_backfill.json")
          print("Backfill exists:", p.exists(), "size MB:", p.stat().st_size / (1024*1024))
          obj = json.loads(p.read_text())
          print("as_of_utc:", obj.get("as_of_utc"))
          syms = obj.get("symbols", {})
          print("symbols:", len(syms))
          samp = next(iter(syms.keys()), None)
          if samp:
              bars = syms[samp].get("bars", [])
              news = syms[samp].get("news", [])
              print("sample:", samp, "bars:", len(bars), "news:", len(news))
          PY

      # ------------------------------------------------------------------
