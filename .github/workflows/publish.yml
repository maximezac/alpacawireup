name: Publish Enriched Feed v2.2.1

on:
  workflow_dispatch:
  push:
    paths:
      - "data/symbols.txt"
      - "fetch_prices.py"
      - "publish_feed.py"
      - "fetch_news.py"
      - ".github/workflows/publish.yml"
      - "requirements.txt"
  schedule:
    - cron: "5 13 * * 1-5"  # 13:05 UTC (~08:05 America/Chicago) on weekdays

permissions:
  contents: write

jobs:
  build-run-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.2.2 numpy==1.26.4 requests==2.32.3 vaderSentiment==3.3.2 python-dateutil==2.9.0.post0 feedparser==6.0.11
          pip install -r requirements.txt || echo "requirements.txt already satisfied."

      # NEW: Fetch multiple months of daily bars into data/prices.json
      - name: Fetch prices from Alpaca
        env:
          ALPACA_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_DATA_FEED: "iex" 
          SYMBOLS_PATH: data/symbols.txt
          OUTPUT_PATH: data/prices.json
          DAYS_BACK: "270"
        run: |
          python fetch_prices.py

      - name: Fetch news from Alpaca
        env:
          ALPACA_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          INPUT_PATH: data/prices.json
          OUTPUT_PATH: data/prices.json   # in-place
          NEWS_LOOKBACK_DAYS: "7"
          NEWS_LIMIT_PER_SYMBOL: "25"
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}   # optional
          FINNHUB_KEY: ${{ secrets.FINNHUB_KEY }}   # optional
          NEWS_SOURCES: "benzinga,mtnewswires,google_rss,finnhub,reddit"
          # Optional: limit sources:
          # NEWS_SOURCES: "benzinga,mtnewswires"
        run: |
          python fetch_news.py

      # Enrich file -> data/prices_final.json (computes indicators+TS, NS neutral if no news)
      - name: Generate enriched feed
        env:
          INPUT_PATH: data/prices.json
          OUTPUT_PATH: data/prices_final.json
          MAX_ARTICLES: "15"
          DECAY_HALF_LIFE_HOURS: "12"
          SECTOR_NUDGE: "0.05"
          GENERATE_NOW: "1"
          ALPACA_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          python publish_feed.py

      - name: Postprocess outputs (slim, portfolio-only, watchlist, trades)
        env:
          INPUT_FINAL: data/prices_final.json
          # thresholds
          BUY_THRESHOLD: "0.35"
          SELL_THRESHOLD: "-0.25"
          # watchlist knobs
          TS_WATCH: "0.50"
          NS_WATCH: "0.50"
          WATCH_TOP: "20"
          # sizing knobs
          A_MAX_DEPLOY_FRAC: "0.15"
          A_PER_LINE_FRAC: "0.04"
          B_PER_LINE_FRAC: "0.02"
          # portfolio paths & cash
          PORT_A_CSV: data/portfolio_a.csv
          PORT_B_CSV: data/portfolio_b.csv
          PORTFOLIO_B_CASH: "500"      # optional, if you want B to have usable cash
          # outputs
          OUT_SLIM: data/prices_final_slim.json
          OUT_PORTA_ONLY: data/prices_final_porta.json
          OUT_PORTB_ONLY: data/prices_final_portb.json
          OUT_WATCHLIST: data/watchlist_summary.json
          OUT_TRADES: data/recommended_trades.json
        run: |
          python scripts/postprocess_outputs.py


      - name: Commit updated feed to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/prices.json data/prices_final.json \
                 data/prices_final_slim.json data/prices_final_porta.json data/prices_final_portb.json \
                 data/watchlist_summary.json data/recommended_trades.json \
                 data/portfolio_a.csv data/portfolio_b.csv
          git commit -m "chore: refresh prices & enriched feed (v2.2.1)" || echo "No changes to commit."
          git push

      # Optional: Update a Gist with prices_final.json
      # - name: Update Gist (optional)
      #   if: ${{ env.GIST_ID != '' }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      #     GH_TOKEN: ${{ secrets.GH_TOKEN }}
      #     GIST_ID: ${{ secrets.GIST_ID }}
      #     GIST_FILENAME: prices_final.json
      #     OUTPUT_PATH: data/prices_final.json
      #   run: |
      #     python scripts/update_gist.py
